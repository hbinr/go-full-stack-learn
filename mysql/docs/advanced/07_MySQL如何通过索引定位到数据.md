# MySQL如何通过索引定位到数据

既然谈到了MySQL如何通过索引定位到数据，那么就不得不了解下InnoDB引擎和MyISAM引擎，而这二者的区别也是面试常考的问题。
## InnoDB引擎和MyISAM引擎区别
MySQL 5.5.5版本后使用InnoDB作为默认的存储引擎

### 事务方面
InnoDB 支持事务， MyISAM 不支持事务。  

这也是MySQL 5.5.5版本后将默认存储引擎从MyISAM变成InnoDB的重要原因之一 
### 外键方面
InnoDB支持外键，而MyISAM不支持。对一个包含外键的InnoDB表转换为MyISAN表会失败
### 索引方面
InnoDB是聚簇索引，MyISAM是非聚簇索引。

MyISAM支持FULLTEXT类型的全文索引

InnoDB不支持FULLTEXT类型的全文索引，但是InnoDB可以使用sphinx插件支持全文索引，并且效果更好

### 锁粒度方面
InnoDB 最小粒度的锁是行锁

MyISAM 最小粒度的锁是表锁。一个更新语句会锁住整张表，导致其他查询和更新都会被阻塞，因此并发访问受限。

这也是MySQL 5.5.5版本后将默认存储引擎从MyISAM变成InnoDB的重要原因之一 

### 硬盘存储结构
InnoDB 在磁盘上使用**两个**文件来存储数据库数据
- `.frm`文件：表的定义文件
- `.ibd`文件：数据和索引存储文件。数据以主键进行聚簇存储，而真正的数据则保存在叶子节点中


MyISAM 在磁盘上使用**三个**文件来存储数据库数据
- `.frm`文件：表的定义文件
- `.MYD`文件：数据文件（MYData），存储真正的数据
- `.MYI`文件；索引文件（MYIndex），存储数据库索引 

## 聚簇索引和非聚簇索引
### 聚簇索引
#### 什么是聚簇索引？
**简单讲：** 就是将**数据与索引放到了一块**，索引结构的 **叶子节点** 保存了行数据  主要是InnoDB采用

**专业点讲：**

聚簇索引就是按照每张表的**主键**构造一颗B+树，同时**叶子节点**中存放的就是整张表的**行记录数据**，也将聚簇索引的叶子节点称为数据页。这个特性决定了索引组织表中数据也是索引的一部分，每张表只能拥有一个聚簇索引。

InnoDB通过主键聚簇数据，如果没有定义主键，InnoDB会选择非空的唯一索引代替。如果没有这样的索引，InnoDB会隐式的定义一个主键来作为聚簇索引。


#### 聚簇索引的优缺点
##### 优点
1. 数据访问更快，因为聚簇索引将索引和数据保存在同一个B+树中，因此从聚簇索引中获取数据比非聚簇索引更快
2. 聚簇索引对于主键的排序查找和范围查找速度非常快
##### 缺点
1. 插入速度严重依赖于插入顺序，按照主键的顺序插入是最快的方式，否则将会出现页分裂，严重影响性能。因此，对于InnoDB表，我们一般都会定义一个自增的ID列为主键
2. 更新主键的代价很高，因为将会导致被更新的行移动。因此，对于InnoDB表，我们一般定义主键为不可更新。
3. 辅助索引(二级索引)访问需要两次索引查找，第一次找到主键值，第二次根据主键值找到行数据。


### 非聚簇索引
#### 什么是非聚簇索引？
将 **数据**与 **索引**分开存储，表数据存储顺序与索引顺序无关。主要是MyISAM采用

索引结构的叶子节点指向了数据的对应行，也就是说叶子节点存储的是指向数据行的物理地址。


**澄清一个概念：** InnoDB中，在**聚簇索引之上**创建的**索引**称之为辅助索引，辅助索引访问数据总是需要二次查找。

**非聚簇索引都是辅助索引**，像复合索引、前缀索引、唯一索引，辅助索引叶子节点存储的不再是行的物理位置，而是主键值

## MyISAM索引查询数据过程

![MyISAM非聚簇索引](../../img/图4%20MyISAM非聚簇索引.png)

**上半图是索引文件示意图**

使B+树作为索引结构，节点存储的是主键id值，如15，56，77等

B+树的最后一层，也就是叶子节点，其data域存储的是指向数据行的物理地址，如0x07，0x56等

**下半图是数据文件示意图**

可以看到，通过索引文件中叶子节点存储的物理地址，可以在数据文件中找到对应数据行
### 以主键为索引，查询数据过程
1. 从`.MYI`文件中开始找索引，B+树节点上找到主键id。
2. 根据该主键id找到对应的叶子节点
3. 叶子节点的data域指向了目标数据行，从 `.MYD` 文件取出数据返回

## InnoDB索引查询数据过程

![InnoDB聚簇索引](../../img/图5%20InnoDB聚簇索引.png)

结合上图，InnoDB的聚簇索引结构是；
- 节点存储了主键id，也就是说以主键为索引
- 最后一层，叶子节点直接存储数据记录，和MyISAM存储物理地址不同。
### 以主键为索引，查询数据过程
InnoDB使用的是聚簇索引，将主键组织到一棵B+树中，而行数据就储存在叶子节点上，若使用"where id = 14"这样的条件查找主键，则按照B+树的检索算法即可查找到对应的叶节点，之后获得行数据。
### 以非主键为索引（辅助索引），查询数据过程
辅助索引在 `.ibd` 文件中，B+数据的节点存储了索引的值，比如name字段，则储存了Tom、小明、小王等实际值

而叶子节点则存储了数据记录的**主键id**

所以若对Name列(将name字段设为索引 )进行条件搜索，则需要两个步骤：
- 第一步在辅助索引B+树中检索Name，到达其叶子节点获取对应的主键。
- 第二步使用主键在主索引B+树种再执行一次B+树检索操作，最终到达叶子节点即可获取整行数据。

以下为通过索引检索数据过程图示：

![根据索引查找数据过程](../../img/图6%20根据索引查找数据过程.png)


- 对于主键索引，InnoDB检索数据比MyISAM检索数据快，直接就拿到数据了
- 对于辅助索引，InnoDB检索数据比MyISAM检索数据要慢点，需要二次查找，也称回表   
  - 当然，如果执行的SQL里使用到了覆盖索引，那么检索数据就查询一次，速度还是比MyISAM快的。这就是不推荐使用 `select *`的原因，如果查询的字段已经建了索引，那么就不需要回表操作了。

## 主键索引是聚簇索引还是非聚簇索引？
在Innodb下主键索引是聚簇索引，在Myisam下主键索引是非聚簇索引


**补充：**

由于叶子节点(数据页)只能按照一颗B+树排序，故一张表只能有一个聚簇索引。辅助索引的存在不影响聚簇索引中数据的组织，所以一张表可以有多个辅助索引。

参考；

https://www.bilibili.com/video/BV1wV411h7Fb

https://www.jianshu.com/p/fa8192853184

https://www.cnblogs.com/jiawen010/p/11805241.html