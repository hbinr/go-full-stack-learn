# 单线程架构

Redis 使⽤了单线程架构和 I/O 多路复⽤模型来实现⾼性能的内存数据
库服务

## 一.引出单线程模型

现在开启了三个 redis-cli 客⼾端同时执⾏命令。

客⼾端 1 设置⼀个字符串键值对：
`127.0.0.1:6379> set hello world`

客⼾端 2 对 counter 做⾃增操作：
`127.0.0.1:6379> incr counter`

客⼾端 3 对 counter 做⾃增操作：
`127.0.0.1:6379> incr counter`

Redis 客⼾端与服务端的模型可以简化成图 2-3，每次客⼾端调⽤都经
历了发送命令、执⾏命令、返回结果三个过程。

![图2.3 客⼾端与服务端请求过程](../../img/图%202-3%20Redis%20客⼾端与服务端请求过程.jpg)

图 2.3 客⼾端与服务端请求过程

其中第 2 步是重点要讨论的，因为 Redis 是单线程来处理命令的，所以
⼀条命令从客⼾端达到服务端不会⽴刻被执⾏，所有命令都会进⼊⼀个队列
中，然后逐个被执⾏。

所以上⾯ 3 个客⼾端命令的执⾏顺序是不确定的（如
图 2-4 所⽰）：

![图2.4 所有命令在⼀个队列⾥排队等待被执⾏](../../img/图%202-4%20所有命令在⼀个队列⾥排队等待被执⾏.jpg)

图 2.4 所有命令在⼀个队列⾥排队等待被执⾏

但是可以确定不会有两条命令被同时执⾏（如图 2-5 所⽰）：

![图2.5 不存在多个命令被同时执⾏的情况](../../img/图%202-5%20不存在多个命令被同时执⾏的情况.jpg)

图 2.5 不存在多个命令被同时执⾏的情况

所以两条 incr 命令⽆论怎么执⾏最终结果都是 2，不会产⽣并发问题，这就
是 Redis 单线程的基本模型。但是像发送命令、返回结果、命令排队肯定不
像描述的这么简单，Redis 使⽤了 I/O 多路复⽤技术来解决 I/O 的问题。

## 二.为什么单线程还能这么快

通常来讲，单线程处理能⼒要⽐多线程差，例如有 10000 ⽄货物，每
辆⻋的运载能⼒是每次 200 ⽄，那么要 50 次才能完成，但是如果有 50 辆
⻋，只要安排合理，只需要⼀次就可以完成任务。那么为什么 Redis 使⽤单
线程模型会达到每秒万级别的处理能⼒呢？可以将其归结为三点：

### 第⼀，纯内存访问

Redis 将所有数据放在内存中，内存的响应时⻓⼤
约为 100 纳秒，这是 Redis 达到每秒万级别访问的重要基础。

### 第⼆，⾮阻塞 I/O

Redis 使⽤ epoll 作为 I/O 多路复⽤技术的实现，
再加上 Redis ⾃⾝的事件处理模型将 epoll 中的连接、读写、关闭都转换为
事件，不在⽹络 I/O 上浪费过多的时间，如图 2-6 所⽰。

![图2.6 使⽤ IO 多路复⽤和⾃⾝事件模型](../../img/图%202-6%20Redis%20使⽤%20IO%20多路复⽤和⾃⾝事件模型.jpg)

图 2.6 使⽤ IO 多路复⽤和⾃⾝事件模型

### 第三，单线程避免了线程切换和竞态产⽣的消耗。

既然采⽤单线程就能达到如此⾼的性能，那么也不失为⼀种不错的选
择，因为单线程能带来⼏个好处：

- 第⼀，单线程可以简化数据结构和算法的
  实现。如果对⾼级编程语⾔熟悉的读者应该了解并发数据结构实现不但困难
  ⽽且开发测试⽐较⿇烦。
- 第⼆，单线程避免了线程切换和竞态产⽣的消耗，
  对于服务端开发来说，锁和线程切换通常是性能杀⼿。

但是单线程会有⼀个问题：对于每个命令的执⾏时间是有要求的。如果
某个命令执⾏过⻓，会造成其他命令的阻塞，对于 Redis 这种⾼性能的服务
来说是致命的，所以 Redis 是**⾯向快速执⾏场景**的数据库。

2020 年 5 月 2 日发布了 6.0 版本，已经开始支持多线程了。下一节记录多线程./img/图 2.7%20 单线程原因.jpg)
